name: Tests Automatiques

# Exécuter les tests sur chaque push et pull request
on:
  push:
    branches: [ main, master, claude/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Tests unitaires avec Jest
  unit-tests:
    name: Tests Unitaires (Jest)
    runs-on: ubuntu-latest

    steps:
      - name: Récupérer le code
        uses: actions/checkout@v4

      - name: Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installer les dépendances
        run: npm ci

      - name: Exécuter les tests unitaires
        run: npm test

      - name: Générer le rapport de couverture
        run: npm run test:coverage

      - name: Uploader le rapport de couverture
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # Tests E2E avec Playwright
  e2e-tests:
    name: Tests E2E (Playwright)
    runs-on: ubuntu-latest

    steps:
      - name: Récupérer le code
        uses: actions/checkout@v4

      - name: Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installer les dépendances
        run: npm ci

      - name: Installer les navigateurs Playwright
        run: npx playwright install --with-deps chromium

      - name: Démarrer le serveur web local
        run: |
          python3 -m http.server 8000 &
          sleep 3

      - name: Exécuter les tests E2E
        run: npm run test:e2e

      - name: Uploader les résultats Playwright
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # Validation HTML
  html-validation:
    name: Validation HTML
    runs-on: ubuntu-latest

    steps:
      - name: Récupérer le code
        uses: actions/checkout@v4

      - name: Installer le validateur HTML
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install html5validator

      - name: Valider les fichiers HTML
        run: |
          html5validator --root . --match "*.html" --ignore node_modules --log INFO || true

  # Vérification de sécurité
  security-check:
    name: Vérification de Sécurité
    runs-on: ubuntu-latest

    steps:
      - name: Récupérer le code
        uses: actions/checkout@v4

      - name: Installer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Audit de sécurité npm
        run: npm audit --audit-level=moderate || true

  # Résumé des tests
  test-summary:
    name: Résumé des Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests, html-validation, security-check]
    if: always()

    steps:
      - name: Afficher le statut
        run: |
          echo "✅ Tests unitaires: ${{ needs.unit-tests.result }}"
          echo "✅ Tests E2E: ${{ needs.e2e-tests.result }}"
          echo "✅ Validation HTML: ${{ needs.html-validation.result }}"
          echo "✅ Sécurité: ${{ needs.security-check.result }}"
